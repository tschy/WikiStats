<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WikiStats</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

  <style>
    body { font-family: sans-serif; max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    form { display: flex; gap: 10px; align-items: end; flex-wrap: wrap; }
    label { display: flex; flex-direction: column; gap: 6px; }
    input { padding: 8px; min-width: 240px; }
    button { padding: 9px 14px; }
    #status { margin: 12px 0; white-space: pre-wrap; }
    #status.ok { color: #333; }
    #status.err { color: #b00020; }
    #chartWrap { height: 380px; }

    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin: 8px 0 12px; }
    .toolbar button { padding: 6px 10px; font-size: 12px; }
    .hint { font-size: 12px; color: #555; }
    /* ... existing preview styles ... */
  </style>
</head>
<body>
  <h1>WikiStats</h1>

  <form id="form">
    <label>
      Wikipedia page title
      <input id="title" value="Earth" />
    </label>

    <label>
      From
      <input id="from" type="date" />
      <div class="hint">Optional. If set, set “To” too.</div>
    </label>

    <label>
      To
      <input id="to" type="date" />
      <div class="hint">Inclusive end date.</div>
    </label>

    <label>
      Limit
      <input id="limit" type="number" value="300" min="1" max="5000" />
    </label>

    <button id="loadBtn" type="submit">Load</button>
  </form>

  <div class="toolbar">
    <button type="button" data-days="7">Last 7d</button>
    <button type="button" data-days="30">Last 30d</button>
    <button type="button" data-days="365">Last 365d</button>
    <button type="button" data-days="0">All time</button>
    <button id="resetZoomBtn" type="button" title="Reset chart zoom">Reset zoom</button>
    <span class="hint">Zoom: mouse wheel / pinch / drag</span>
  </div>

  <div id="status" class="ok"></div>

  <div id="preview">
    <div id="previewInner">
      <img id="previewImg" alt="" />
      <div>
        <h2 id="previewTitle"></h2>
        <div id="previewMeta"></div>
        <div id="previewExtract"></div>
      </div>
    </div>
  </div>

  <div id="chartWrap">
    <canvas id="chart"></canvas>
  </div>

  <script>
    const statusEl = document.getElementById("status");
    const canvas = document.getElementById("chart");

    const previewEl = document.getElementById("preview");
    const previewImg = document.getElementById("previewImg");
    const previewTitle = document.getElementById("previewTitle");
    const previewMeta = document.getElementById("previewMeta");
    const previewExtract = document.getElementById("previewExtract");

    const titleEl = document.getElementById("title");
    const fromEl = document.getElementById("from");
    const toEl = document.getElementById("to");
    const limitEl = document.getElementById("limit");
    const loadBtn = document.getElementById("loadBtn");
    const resetZoomBtn = document.getElementById("resetZoomBtn");

    const fmt = new Intl.NumberFormat(undefined);

    let chart;

    function setStatusOk(msg) {
      statusEl.classList.remove("err");
      statusEl.classList.add("ok");
      statusEl.textContent = msg;
    }

    function setStatusErr(msg) {
      statusEl.classList.remove("ok");
      statusEl.classList.add("err");
      statusEl.textContent = msg;
    }

    function toIsoDate(d) {
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function setLastDays(days) {
      if (!days) {
        fromEl.value = "";
        toEl.value = "";
        return;
      }
      const today = new Date();
      const start = new Date(today);
      start.setDate(today.getDate() - days);
      fromEl.value = toIsoDate(start);
      toEl.value = toIsoDate(today);
    }

    function validateInputs() {
      const title = titleEl.value.trim();
      if (!title) return { ok: false, msg: "Please enter a Wikipedia page title." };

      const from = fromEl.value;
      const to = toEl.value;

      if ((from && !to) || (!from && to)) {
        return { ok: false, msg: "Please set both From and To, or leave both empty." };
      }
      if (from && to && from > to) {
        return { ok: false, msg: "From must be the same as or before To." };
      }

      const limit = Number(limitEl.value);
      if (!Number.isFinite(limit) || limit < 1 || limit > 5000) {
        return { ok: false, msg: "Limit must be a number between 1 and 5000." };
      }

      return { ok: true, title, from, to, limit };
    }

    function saveFormState() {
      const state = {
        title: titleEl.value.trim(),
        from: fromEl.value,
        to: toEl.value,
        limit: limitEl.value
      };
      localStorage.setItem("wikistats.form", JSON.stringify(state));
    }

    function restoreFormState() {
      try {
        const raw = localStorage.getItem("wikistats.form");
        if (!raw) return false;
        const s = JSON.parse(raw);
        if (typeof s.title === "string") titleEl.value = s.title;
        if (typeof s.from === "string") fromEl.value = s.from;
        if (typeof s.to === "string") toEl.value = s.to;
        if (typeof s.limit === "string" || typeof s.limit === "number") limitEl.value = String(s.limit);
        return true;
      } catch {
        return false;
      }
    }

    document.querySelectorAll("button[data-days]").forEach(btn => {
      btn.addEventListener("click", () => {
        setLastDays(Number(btn.getAttribute("data-days")));
        saveFormState();
      });
    });

    [titleEl, fromEl, toEl, limitEl].forEach(el => el.addEventListener("change", saveFormState));

    async function fetchSeries(title, limit, from, to) {
      const url = new URL("/api/revisions", window.location.origin);
      url.searchParams.set("title", title);
      url.searchParams.set("limit", String(limit));
      if (from) url.searchParams.set("from", from);
      if (to) url.searchParams.set("to", to);

      const res = await fetch(url.toString());
      const text = await res.text();
      if (!res.ok) throw new Error(`HTTP ${res.status}\n${text}`);
      return JSON.parse(text);
    }

    async function fetchPreview(title) {
      const url = new URL("/api/preview", window.location.origin);
      url.searchParams.set("title", title);

      const res = await fetch(url.toString());
      const text = await res.text();
      if (!res.ok) throw new Error(`HTTP ${res.status}\n${text}`);
      return JSON.parse(text);
    }

    function renderPreview(p) {
      if (!p || (!p.extract && !p.thumbnailUrl && !p.pageUrl)) {
        previewEl.style.display = "none";
        return;
      }

      previewEl.style.display = "block";

      if (p.thumbnailUrl) {
        previewImg.src = p.thumbnailUrl;
        previewImg.style.display = "block";
      } else {
        previewImg.removeAttribute("src");
        previewImg.style.display = "none";
      }

      previewMeta.textContent = p.description || "";
      previewExtract.textContent = (p.extract || "").slice(0, 340) + ((p.extract || "").length > 340 ? "…" : "");

      previewTitle.innerHTML = "";
      if (p.pageUrl) {
        const a = document.createElement("a");
        a.href = p.pageUrl;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.textContent = p.title || "Open on Wikipedia";
        previewTitle.appendChild(a);
      } else {
        previewTitle.textContent = p.title || "";
      }
    }

    function buildChart(series) {
      // Use "time" scale: x is an actual Date, ticks can show date-only,
      // tooltips can show full timestamp.
      const sizePoints = series.points.map(p => ({ x: new Date(p.timestamp), y: p.size }));
      const deltaPoints = series.points.map(p => ({ x: new Date(p.timestamp), y: p.delta }));

      const dateOnly = new Intl.DateTimeFormat(undefined, { year: "numeric", month: "2-digit", day: "2-digit" });

      chart = new Chart(canvas, {
        type: "line",
        data: {
          datasets: [
            { label: "Size (bytes)", data: sizePoints, borderWidth: 2, pointRadius: 0, tension: 0.15, yAxisID: "ySize" },
            { label: "Delta (bytes)", data: deltaPoints, borderWidth: 1, pointRadius: 0, tension: 0.15, yAxisID: "yDelta" }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          parsing: false, // we already provide {x,y}
          interaction: { mode: "index", intersect: false },
          plugins: {
            tooltip: {
              callbacks: {
                title: (items) => {
                  const x = items?.[0]?.parsed?.x;
                  return x ? new Date(x).toLocaleString() : "Revision";
                },
                label: (ctx) => {
                  const dsLabel = ctx.dataset.label || "";
                  const val = ctx.parsed.y;

                  if (dsLabel.startsWith("Size")) {
                    return `Size: ${fmt.format(val)} bytes (total page size after this revision)`;
                  }
                  if (dsLabel.startsWith("Delta")) {
                    const sign = val > 0 ? "+" : "";
                    return `Delta: ${sign}${fmt.format(val)} bytes (change vs previous revision)`;
                  }
                  return `${dsLabel}: ${fmt.format(val)}`;
                }
              }
            },
            legend: { display: true },

            // Zoom/pan (chartjs-plugin-zoom)
            zoom: {
              pan: { enabled: true, modifierKey: "shift", mode: "x" },
              zoom: {
                wheel: { enabled: true },
                pinch: { enabled: true },
                drag: { enabled: true, borderColor: "#888", borderWidth: 1, backgroundColor: "rgba(120,120,120,0.15)" },
                mode: "x"
              }
            }
          },
          scales: {
            x: {
              type: "time",
              time: { unit: "day" },
              ticks: {
                maxTicksLimit: 8,
                callback: (value) => dateOnly.format(new Date(value))
              }
            },
            ySize: { type: "linear", position: "left", title: { display: true, text: "Size" } },
            yDelta: { type: "linear", position: "right", title: { display: true, text: "Delta" }, grid: { drawOnChartArea: false } }
          }
        }
      });
    }

    function updateChart(series) {
      const sizePoints = series.points.map(p => ({ x: new Date(p.timestamp), y: p.size }));
      const deltaPoints = series.points.map(p => ({ x: new Date(p.timestamp), y: p.delta }));

      chart.data.datasets[0].data = sizePoints;
      chart.data.datasets[1].data = deltaPoints;
      chart.update();
    }

    async function loadWithUiState() {
      const v = validateInputs();
      if (!v.ok) {
        setStatusErr(v.msg);
        return;
      }

      saveFormState();

      loadBtn.disabled = true;
      setStatusOk("Loading…");

      try {
        const [preview, series] = await Promise.all([
          fetchPreview(v.title).catch(err => {
            previewEl.style.display = "none";
            console.warn("Preview failed:", err);
            return null;
          }),
          fetchSeries(v.title, v.limit, v.from, v.to)
        ]);

        if (preview) renderPreview(preview);
        if (!chart) buildChart(series);
        else updateChart(series);

        setStatusOk(`Loaded ${series.points.length} revisions for "${series.title}". Hover the graph for details.`);
      } catch (err) {
        setStatusErr(String(err));
      } finally {
        loadBtn.disabled = false;
      }
    }

    document.getElementById("form").addEventListener("submit", (e) => {
      e.preventDefault();
      loadWithUiState();
    });

    resetZoomBtn.addEventListener("click", () => {
      if (chart && typeof chart.resetZoom === "function") chart.resetZoom();
    });

    // Initial state
    const restored = restoreFormState();
    if (!restored && !fromEl.value && !toEl.value) setLastDays(30);

    loadWithUiState();
  </script>
</body>
</html>